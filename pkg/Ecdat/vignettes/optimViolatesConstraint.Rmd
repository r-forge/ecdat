---
title: "optim(..., method='L-BFGS-B') violates constraint"
author: "Spencer Graves"
date: "`r Sys.Date()`"
output:
    rmarkdown::html_vignette:
        fig_caption: yes
vignette: >
  %\VignetteIndexEntry{optim violates constraint}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}{inputenc}
---
```{r setup, include = FALSE, cache = FALSE}
library(RefManageR)
bibFile <- system.file("Bib", "biblatexExamples.bib", 
                           package = "RefManageR")
bib <- ReadBib(bibFile, check = FALSE)
#bibF2 <- "AvgInc.bib"
#bib2 <- ReadBib(bibF2) 
BibOptions(check.entries = FALSE, style = "markdown",
           cite.style = "authoryear",
           bib.style = "numeric")
```
# Abstract 

This vignette provides an example where optim(..., method='L-BFGS-B') stops with an error message while testing a value of a parameter below the lower bound.  It may be removed from the Ecdat package if optim is fixed to no longer exhibit this behavior.  

# Introduction 

The vignette was prepared in case someone on the R Core team might want to use it study an apparent problem with [optim(..., method='L-BFGS-B')](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/optim.html).

This example uses the USGDPpresidents data in the [development version of the Ecdat pack on R-Forge](https://r-forge.r-project.org/R/?group_id=1439). 

# Get the data 

If you do not have the R-Forge development version of Ecdat, install it;  the version on CRAN does not contain this vignette:  

$```{r installEcdat}
install.packages("Ecdat",
    repos="http://R-Forge.R-project.org")
$```

Make a local copy of USGDPpresidents since 1790:  

```{r selectRecent}
suppressMessages(library(Ecdat))
GDPna <- is.na(USGDPpresidents$realGDPperCapita)
GDP. <- USGDPpresidents[!GDPna,]

GDP.$executive <- ordered(GDP.$executive)

GDP <- GDP.
GDP$realGDPperCapita <- ts(GDP$realGDPperCapita, 
                             GDP$Year[1])
```

Attach the [KFAS (Kalman filtering and smoothing)](https://rweb.crmda.ku.edu/cran/web/packages/KFAS/KFAS.pdf) package:  

```{r}
suppressMessages(library(KFAS))
```

Set up the model with the problem:  

```{r setupMdl}
N <- nrow(GDP)

(a1.2 <- c(level=log(GDP$realGDPperCapita[1]), slope=0))

EWMA2pres1Q.slope <- array(0, c(1,1,N), 
      dimnames=list('slope', 'slope', GDP$Year))
contin <- duplicated(GDP$executive)
presLastYr <- c(!contin[-1], FALSE)

EWMA2pres1fmla <- log(realGDPperCapita) ~ 
  SSMtrend(2, Q = list(lnQ.lvl=matrix(NA), 
              lnQ.slope=EWMA2pres1Q.slope), a1=a1.2,
           ynames='lnGDPperCap') 
EWMA2pres1mdl <-SSModel(EWMA2pres1fmla, 
          GDP, H=matrix(NA))

EWMA2init2 <- rep(1, 3)
names(EWMA2init2) <- c('Q.lvl', 'Q.slope', 'H')
EWMA2pres1updt2 <- function(pars=EWMA2init2,
              model=EWMA2pres1mdl, ...){
  Q <- model$Q
  Q[1,1,] <- pars[1]
  Q[2,2,presLastYr] <- pars[2]
  model$Q <- Q
  model$H[] <- pars[3]
  model
} 
# calling fitSSM{KFAS}
#EWMA2pres1fit2 <- fitSSM(EWMA2pres1mdl,
#    inits=EWMA2init2, updatefn=EWMA2pres1updt2,  
#    method = "L-BFGS-B", lower=rep(0, 3), 
#    upper=rep(Inf, 3))
#EWMA2pres1fit2$optim.out

likfn <- function(pars, model, ...) {
    model <- do.call(EWMA2pres1updt2, 
        args = c(list(pars, model), NULL))
#    if (checkfn(model)) {
      return(-logLik(object = model, 
         check.model = FALSE, 
                     theta = theta, ...))
}

library(optimrx)
# Calling optim directly 
optim.out <- optimr(par = EWMA2init2, 
    fn = likfn,  method = "L-BFGS-B", lower=0, 
    upper=Inf, model = EWMA2pres1mdl)
optim.out

opm.out <- opm(par = EWMA2init2, 
    fn = likfn,  method = "ALL", lower=0, 
    upper=Inf, model = EWMA2pres1mdl)
summary(opm.out, order=value)

## Now put in numerical derivatives via numDeriv (grnd), use grfwd, grback, grcentral also
opmnd.out <- opm(par = EWMA2init2, 
    fn = likfn, gr="grnd", method = "ALL", lower=0, 
    upper=Inf, model = EWMA2pres1mdl)
summary(opmnd.out, order=value)



```

Note that [optim(..., method='L-BFGS-B')](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/optim.html) stopped with an error message while violating the lower bound for par[2].  

[optimx](https://rweb.crmda.ku.edu/cran/web/packages/optimx/optimx.pdf) allows trying the same starting values with multiple algorithms.  

```{r}
suppressMessages(library(optimx))
optimx.out <- optimx(par = EWMA2init2, fn = likfn, 
  method = c("L-BFGS-B", 'nlm', 'nlminb', 'spg', 
        'ucminf', 'newuoa', 'bobyqa', 'nmkb', 
        'hjkb', 'Rcgmin', 'Rvmmin'), 
  lower=0, upper=Inf, model = EWMA2pres1mdl)

o3 <- order(optimx.out$value)
optimx.out[o3, 
   c('Q.lvl', 'Q.slope', 'H', 'value', 'kkt1', 'kkt2')]

```

nlminb and nmkb got essentially the same answers, but even they did not claim convergence by the kkt1 criterion.  

What happens if we start at the best answer so far?  

```{r}
(EWMA2init3 <- unlist(optimx.out[o3[1], 1:3]))
optimx4 <- optimx(par = EWMA2init3, fn = likfn, 
  method = c("L-BFGS-B", 'nlm', 'nlminb', 'spg', 
        'ucminf', 'newuoa', 'bobyqa', 'nmkb', 
        'hjkb', 'Rcgmin', 'Rvmmin'), 
  lower=0, upper=Inf, model = EWMA2pres1mdl)

o4 <- order(optimx4$value)
optimx4[o4, 
   c('Q.lvl', 'Q.slope', 'H', 'value', 'kkt1', 'kkt2')]
```
